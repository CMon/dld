 /*
  * dldExchangeServerDBusStrength.cpp  - domestic location detection - Exchange Server DBus Strength Strat
  *
  * Copyright (c) by Simon Schäfer <Simon.Schaefer@koeln.de>
  *
  * *************************************************************************
  * *                                                                       *
  * * This program is free software; you can redistribute it and/or modify  *
  * * it under the terms of the GNU General Public License as published by  *
  * * the Free Software Foundation; either version 2 of the License, or     *
  * * (at your option) any later version.                                   *
  * *                                                                       *
  * *************************************************************************
 */
/** @class DLDExchangeServerDBusStrength dldExchangeServerDBusStrength.h
 *
 * @author Simon Schaefer
 *
 * @date 18.02.2008
 *
 * @version 1.0
 * <br> Class for the DLD exchange server D-Bus Strength strategy
 */
#include "dldExchangeServerStrategy.h"
#include "dldExchangeServerDBusStrength.h"
#include "dldLog.h"

#include <QVariant>
#include <QString>
#include <QtDBus>

#include <qdebug.h>

/**
 * @brief constructor for DLDExchangeServerDBusStrength class
 * @param logAddress is the pointer of the parents log class
 * @param connectionBasePath in this case its the service name
 * @param subPath the subpath for the service
 * @return
 *      void
 */
DLDExchangeServerDBusStrength::DLDExchangeServerDBusStrength (DLDLog * pLog, QString connectionBasePath, QString subPath)
{
	log = pLog;

// build up dbus connection:
	dBus = new QDBusConnection ("");
	dBus->connectToBus (QDBusConnection::ActivationBus, "");
	if (!dBus->sessionBus().isConnected())
	{
		log->errorLog ("Cannot connect to the D-BUS session bus.\nTo start it, run:\n\teval `dbus-launch --auto-syntax`");
		return ;
	}
	if (!dBus->sessionBus().registerService(connectionBasePath))
	{
		log->errorLog (QString ("%1").arg(qPrintable(QDBusConnection::sessionBus().lastError().message())));
		return ;
	}
	dBus->sessionBus().registerObject(QString ("/%1").arg(subPath), this, QDBusConnection::ExportScriptableSlots | QDBusConnection::ExportAllSignals);
}
/**
 * @brief destructor for DLDExchangeServerDBusStrength class
 * @return
 *      void
 */
DLDExchangeServerDBusStrength::~DLDExchangeServerDBusStrength ()
{
	if (dBus)
		delete (dBus);
}
/**
 * @brief slot: updates the node data in the internal struct and emits the signal updatedNode, this slot is used to work in both directions
 * @param id	id of the node to update
 * @param x	x coordination of the node
 * @param y	y coordination of the node
 * @param z	z coordination of the node
 * @return
 *      void
 */
void DLDExchangeServerDBusStrength::updateNode (int id, double x, double y, double z)
{
	ThreeDPoint tmp = nodeInfo[id];
	tmp.x = x;
	tmp.y = y;
	tmp.z = z;

	nodeInfo[id] = tmp;
	emit updatedNode (id, x, y, z);
}
/**
 * @brief slot: returns the tagId string of all seen tags
 * @return
 *      QString returns tagId string; tagId1|tagId2|...
 */
QString DLDExchangeServerDBusStrength::getTagList ()
{
	QString rtString;
	if (tagInfo.isEmpty())
		return ("noTags");
	QMapIterator<int, StrengthType> i(tagInfo);
	while (i.hasNext())
	{
		i.next();
		rtString.append (QString ("%1|").arg(i.key()));
	}
	return (rtString);
}
/**
 * @brief slot: returns the nodeId string of all attached nodes
 * @return
 *      QString returns tagId string; nodeId|nodeId||...
 */
QString DLDExchangeServerDBusStrength::getNodeList ()
{
	QString rtString;
	if (nodeInfo.isEmpty())
		return ("noNodes");
	QMapIterator<int, ThreeDPoint> i(nodeInfo);
	while (i.hasNext())
	{
		i.next();
		rtString.append (QString ("%1|").arg(i.key()));
	}
	return (rtString);
}
/**
 * @brief slot: returns the strengthString of a tag
 * @param tagId the id of the tag
 * @return
 *      QString return strength string; nodeId1=strength1|nodeId2=strength2|...
 */
QString DLDExchangeServerDBusStrength::getStrengths (int tagId)
{
	QString rtString;
	if (tagInfo.isEmpty())
		return ("noTags");
	StrengthType	strengths = tagInfo[tagId];
	if (strengths.isEmpty())
		return ("noStrengthInformation");

	QMapIterator<int, double> i(strengths);
	while (i.hasNext())
	{
		i.next();
		rtString.append (QString ("%1=%2|").arg(i.key()).arg(i.value()));
	}
	return (rtString);
}
/**
 * @brief slot: updates the strength data of a tag in the internal struct and emits the signal updatedStrength, this slot is used to work in both directions
 * @param deviceId	id of the device whos strength is reported
 * @param tagId		id of the tag whos strength is received
 * @param strength	the strength of the tag
 * @return
 *      void
 */
void DLDExchangeServerDBusStrength::updateStrength (int deviceId, int tagId, double strength)
{
	StrengthType tmp = tagInfo[tagId];
	tmp.insert (deviceId, strength);
	tagInfo.insert (tagId, tmp);

	emit updatedStrength (deviceId, tagId, strength);
}
/**
 * @brief slot: returns the position string of a node device
 * @param deviceId the id of the device
 * @return
 *      QString return position string; x=<x>|y=<y>|z=<z>
 */
QString DLDExchangeServerDBusStrength::getNodeInfo (int deviceId)
{
	if (nodeInfo.isEmpty())
		return ("noNodes");
	if (!nodeInfo.contains(deviceId))
		return ("no node information");

	QString rtc = QString ("x=%1|y=%2|z=%3").arg(nodeInfo[deviceId].x).arg(nodeInfo[deviceId].y).arg(nodeInfo[deviceId].z);
	return (rtc);
}
/**
 * @brief slot: updates the position data of the tag
 * @param tagId		id of the tag
 * @param timeStamp	timestamp of the position arrival
 * @param x		x position of the tag
 * @param y		y position of the tag
 * @param z		z position of the tag
 * @return
 *      void
 */
void DLDExchangeServerDBusStrength::updatePosition (int tagId, int timestamp, double x, double y, double z)
{
	// do nothing
}
/**
 * @brief set the maximum axis value
 * @param maximumAxisValue	maximum axis value
 * @return
 *      void
 */
void DLDExchangeServerDBusStrength::setMaximumAxisValue (double maximumAxisValue)
{
	this->maximumAxisValue = maximumAxisValue;
	emit updatedMaximumAxisValue (maximumAxisValue);
}
/**
 * @brief slot: returns the maximum axis value (for the device)
 * @return
 *      int value
 */
int DLDExchangeServerDBusStrength::getMaximumAxisValue ()
{
	return (maximumAxisValue);
}
